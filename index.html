<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortnite Asset Explorer</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Font 'Inter' for a clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply the Inter font to the entire body */
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom scrollbar for better aesthetics, mimicking the original design */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Simple pulse animation for loading skeletons */
        @keyframes pulse {
            50% {
                opacity: .5;
            }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Style for the "Scroll to Top" button, initially hidden */
        #scroll-to-top-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 3rem;
            height: 3rem;
            background-color: #4b5563;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.2s ease;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        #scroll-to-top-btn:hover {
            transform: scale(1.1);
            background-color: #6b7280;
        }

        #scroll-to-top-btn.visible {
            opacity: 1;
        }

        /* Styles for the modal backdrop and content */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }
        .modal-backdrop.active {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: #1f2937;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .modal-backdrop.active .modal-content {
            transform: scale(1);
        }
        
        /* New styles for the shine animation on cards */
        .shine-animation {
            position: relative;
            overflow: hidden;
        }

        .shine-animation::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                to bottom,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: translateY(-100%);
            animation: shine 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes shine {
            0% {
                transform: translateY(-100%);
            }
            50% {
                transform: translateY(100%);
            }
            100% {
                transform: translateY(-100%);
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 md:p-8 min-h-screen">
    <!-- Main container for the entire application, centered on the page -->
    <div class="max-w-7xl mx-auto">
        <!-- Header with title and navigation -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-6 md:mb-8 space-y-4 md:space-y-0">
            <h1 class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 via-pink-500 to-red-500">
                Fortnite Asset Explorer
            </h1>
            <!-- Language and Version display in the header -->
            <div class="flex items-center space-x-4">
                <span id="app-version-display" class="text-xs text-gray-400"></span>
                <select id="language-select" class="bg-gray-800 text-gray-100 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 transition-colors">
                    <option value="de">Deutsch</option>
                    <option value="en">English</option>
                </select>
            </div>
        </header>

        <!-- Navigation Buttons -->
        <nav class="flex flex-wrap justify-center sm:justify-start gap-3 mb-6">
            <!-- Buttons for different cosmetic categories -->
            <button id="show-outfits-btn" data-category="outfit" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Outfits</button>
            <button id="show-backpacks-btn" data-category="backpack" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Rucksäcke</button>
            <button id="show-pickaxes-btn" data-category="pickaxe" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Spitzhacken</button>
            <button id="show-gliders-btn" data-category="glider" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Hängegleiter</button>
            <button id="show-emotes-btn" data-category="emote" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Emotes</button>
            <button id="show-wraps-btn" data-category="wrap" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Lackierungen</button>
            <button id="show-music-btn" data-category="music" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Musik</button>
            <button id="show-lobby-backgrounds-btn" data-category="loading_screen" class="nav-btn bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">Lobby-Hintergründe</button>
        </nav>

        <!-- Filter and Sort Controls -->
        <!-- The controls are always visible now -->
        <div id="filter-sort-controls" class="flex flex-wrap items-center justify-between gap-4 mb-6">
            <!-- Search input -->
            <input type="text" id="search-input" placeholder="Suchen Sie nach Artikeln..." class="bg-gray-800 text-gray-100 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 transition-colors w-full sm:w-auto">
            <!-- Display search results count -->
            <span id="search-results-count" class="text-gray-400 text-sm"></span>

            <!-- Sort dropdown -->
            <div class="flex items-center space-x-2">
                <label for="sort-select" class="text-gray-400">Sortieren:</label>
                <select id="sort-select" class="bg-gray-800 text-gray-100 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 transition-colors">
                    <option value="name">Name (A-Z)</option>
                    <option value="rarity">Seltenheit</option>
                </select>
            </div>
            <!-- Rarity filter dropdown -->
            <div class="flex items-center space-x-2">
                <label for="rarity-filter-select" class="text-gray-400">Seltenheit:</label>
                <select id="rarity-filter-select" class="bg-gray-800 text-gray-100 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 transition-colors">
                    <option value="all">Alle</option>
                    <option value="legendary">Legendär</option>
                    <option value="epic">Episch</option>
                    <option value="rare">Selten</option>
                    <option value="uncommon">Ungewöhnlich</option>
                    <option value="common">Gewöhnlich</option>
                </select>
            </div>
            <!-- New items filter button -->
            <button id="filter-new-btn" class="bg-gray-800 hover:bg-gray-700 text-gray-100 px-4 py-2 rounded-lg font-medium transition-colors">
                Neue Artikel filtern
            </button>
        </div>

        <!-- Main content area where items are displayed -->
        <div id="item-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
            <!-- Items will be dynamically inserted here -->
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scroll-to-top-btn" aria-label="Zurück nach oben">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

    <!-- Modal for detailed item view -->
    <div id="item-details-modal-backdrop" class="modal-backdrop">
        <div id="item-details-modal-content" class="modal-content relative p-6 w-full max-w-xl max-h-[90vh] overflow-y-auto">
            <!-- Close button -->
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <!-- Modal content will be populated here by JavaScript -->
        </div>
    </div>
    
    <!-- JavaScript for all application logic -->
    <script>
        // --- Configuration & State ---
        // A simple object to store translated UI strings
        const translations = {
            'de': {
                todayShop: 'Shop des Tages',
                outfits: 'Outfits',
                backpacks: 'Rucksäcke',
                pickaxes: 'Spitzhacken',
                gliders: 'Hängegleiter',
                emotes: 'Emotes',
                wraps: 'Lackierungen',
                music: 'Musik',
                lobbyBackgrounds: 'Lobby-Hintergründe',
                filterNewBtn: 'Neue Artikel filtern',
                filterNewBtnActive: 'Alle Artikel anzeigen',
                sortLabel: 'Sortieren:',
                rarityLabel: 'Seltenheit:',
                sortName: 'Name (A-Z)',
                sortRarity: 'Seltenheit',
                rarityAll: 'Alle',
                rarityLegendary: 'Legendär',
                rarityEpic: 'Episch',
                rarityRare: 'Selten',
                rarityUncommon: 'Ungewöhnlich',
                rarityCommon: 'Gewöhnlich',
                appTitle: 'Fortnite Asset Explorer',
                noItemsFound: 'Keine Artikel gefunden.',
                searchInputPlaceholder: 'Suchen Sie nach Artikeln...',
                // Translations for modal content
                description: 'Beschreibung',
                source: 'Herkunft',
                price: 'Preis',
                noDescription: 'Keine Beschreibung verfügbar.',
                noPriceInfo: 'Unbekannt',
                // New translations for item origin
                shop: 'Shop',
                crew: 'Crew',
                battlepass: 'Battle Pass',
                // Translation for last seen in shop
                lastSeen: 'Zuletzt im Shop: Vor {days} Tagen',
                lastSeenToday: 'Zuletzt im Shop: Heute',
                // NEW: Translation for search results count
                searchResultsCount: '{count} Artikel gefunden',
                searchResultsCountOne: '1 Artikel gefunden',
                searchResultsCountNone: 'Keine Artikel gefunden',
                // NEW: Loading text
                loading: 'Lade...',
            },
            'en': {
                todayShop: 'Today\'s Shop',
                outfits: 'Outfits',
                backpacks: 'Backpacks',
                pickaxes: 'Pickaxes',
                gliders: 'Gliders',
                emotes: 'Emotes',
                wraps: 'Wraps',
                music: 'Music',
                lobbyBackgrounds: 'Lobby Backgrounds',
                filterNewBtn: 'Filter New Items',
                filterNewBtnActive: 'Show All Items',
                sortLabel: 'Sort:',
                rarityLabel: 'Rarity:',
                sortName: 'Name (A-Z)',
                sortRarity: 'Rarity',
                rarityAll: 'All',
                rarityLegendary: 'Legendary',
                rarityEpic: 'Epic',
                rarityRare: 'Rare',
                rarityUncommon: 'Uncommon',
                rarityCommon: 'Common',
                appTitle: 'Fortnite Asset Explorer',
                noItemsFound: 'No items found.',
                searchInputPlaceholder: 'Search for items...',
                // Translations for modal content
                description: 'Description',
                source: 'Source',
                price: 'Price',
                noDescription: 'No description available.',
                noPriceInfo: 'Unknown',
                // New translations for item origin
                shop: 'Shop',
                crew: 'Crew',
                battlepass: 'Battle Pass',
                // Translation for last seen in shop
                lastSeen: 'Last seen in shop: {days} days ago',
                lastSeenToday: 'Last seen in shop: Today',
                // NEW: Translation for search results count
                searchResultsCount: '{count} items found',
                searchResultsCountOne: '1 item found',
                searchResultsCountNone: 'No items found',
                // NEW: Loading text
                loading: 'Loading...',
            }
        };

        // Current application state
        let currentLanguage = 'de';
        let currentView = 'outfit';
        let currentSortOrder = 'name';
        let currentFilterRarity = 'all';
        let isFilteringNew = false;
        let currentSearchQuery = ''; 
        let cosmeticData = {}; // Cache for fetched data
        const appVersion = 'V2.51';

        // --- DOM Elements ---
        const navButtons = document.querySelectorAll('.nav-btn');
        const itemGrid = document.getElementById('item-grid');
        const languageSelect = document.getElementById('language-select');
        const sortSelect = document.getElementById('sort-select');
        const rarityFilterSelect = document.getElementById('rarity-filter-select');
        const filterNewBtn = document.getElementById('filter-new-btn');
        const appVersionDisplay = document.getElementById('app-version-display');
        const searchInput = document.getElementById('search-input');
        const scrollToTopBtn = document.getElementById('scroll-to-top-btn');
        const filterSortControls = document.getElementById('filter-sort-controls');
        const searchResultsCountDisplay = document.getElementById('search-results-count');

        // Modal elements
        const modalBackdrop = document.getElementById('item-details-modal-backdrop');
        const modalContent = document.getElementById('item-details-modal-content');
        const closeModalBtn = document.getElementById('close-modal-btn');
        
        // --- SVG Icons ---
        // Unknown/no price info icon
        const unknownIcon = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4 text-gray-400">
                <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.558a.75.75 0 10-1.412.576l1.412-.576zM11.25 6a.75.75 0 01.75-.75h.001a.75.75 0 01.75.75v3.75a.75.75 0 01-1.5 0V6z" clip-rule="evenodd" />
            </svg>
        `;

        // V-Bucks icon (inline SVG)
        const vbucksIcon = `
            <svg xmlns="http://www.w3.org/2000/svg" fill="#5DADE2" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-blue-400">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 014.073 4.072M14.25 7.756a4.5 4.5 0 01-4.073 4.072m4.073-4.072A4.5 4.5 0 0118.75 12a4.5 4.5 0 01-4.427 4.928m-4.073-4.072a4.5 4.5 0 014.073-4.072m-4.073 4.072a4.5 4.5 0 01-4.427 4.928M18.75 12a4.5 4.5 0 01-4.5 4.5m4.5-4.5a4.5 4.5 0 01-4.5-4.5m-4.5 9a4.5 4.5 0 014.5-4.5m-4.5 4.5a4.5 4.5 0 014.5 4.5m-4.5-4.5v2.25" />
            </svg>
        `;

        // --- Core Functions ---
        
        /**
         * Fetches cosmetic data for a specific category from the Fortnite-API.com.
         * @param {string} category The category to fetch data for.
         * @returns {Promise<Object[]>} A promise that resolves with the data.
         */
        async function fetchRealCosmeticData(category) {
            try {
                const apiUrl = `https://fortnite-api.com/v2/cosmetics/br/search/all?type=${category}&language=${currentLanguage}`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) {
                    console.error('API Error:', response.status, response.statusText);
                    throw new Error(`API-Fehler: ${response.statusText}`);
                }
                const data = await response.json();
                
                return data.data || [];
            } catch (error) {
                console.error("Fehler beim Abrufen der Daten von der API:", error);
                itemGrid.innerHTML = `<p class="col-span-full text-center text-red-400 text-lg py-12">Es gab ein Problem beim Laden der Daten. Bitte versuchen Sie es später erneut.</p>`;
                return [];
            }
        }
        
        /**
         * Checks if an item is considered "new" based on its introduced date.
         * We define new as being introduced in the last 7 days.
         * @param {Object} item The item to check.
         * @returns {boolean} True if the item is new, false otherwise.
         */
        function isNewItem(item) {
            if (!item.introduction || !item.introduction.date) {
                return false;
            }
            const introducedDate = new Date(item.introduction.date);
            const now = new Date();
            const oneWeekInMs = 7 * 24 * 60 * 60 * 1000;
            return (now - introducedDate) < oneWeekInMs;
        }

        /**
         * Generates the HTML for a single cosmetic item card.
         * The `onload` event on the image is used to remove the shine animation
         * as soon as the image is loaded.
         * @param {Object} item The cosmetic item data from the API.
         * @returns {string} The HTML string for the item card.
         */
        function createItemCard(item) {
            const isNew = isNewItem(item);
            const isNewBadge = isNew ? `<span class="absolute top-2 right-2 bg-purple-500 text-xs font-bold px-2 py-1 rounded-full text-white">Neu</span>` : '';
            
            const rarity = item.rarity ? item.rarity.value : 'common';
            const rarityClass = getRarityColor(rarity);
            const imageUrl = item.images.icon;
            
            let sourceContent = '';
            if (item.price && item.price.price > 0 && item.price.currency === 'VBuck') {
                sourceContent = `<div class="flex items-center space-x-1">
                                    ${vbucksIcon}
                                    <p class="text-xs font-bold text-gray-400">${item.price.price}</p>
                                </div>`;
            } else if (item.battlepass) {
                sourceContent = `<p class="text-xs font-bold text-gray-400">${translations[currentLanguage].battlepass}</p>`;
            } else if (item.crew) {
                sourceContent = `<p class="text-xs font-bold text-gray-400">${translations[currentLanguage].crew}</p>`;
            } else {
                sourceContent = unknownIcon;
            }
            
            // Add the `onload` attribute to the image to remove the animation when loaded
            return `
                <div onclick='showItemDetails(${JSON.stringify(item)})' class="bg-gray-800 rounded-xl p-4 shadow-lg transform transition-transform duration-200 hover:scale-105 relative border-2 ${rarityClass} flex flex-col cursor-pointer shine-animation">
                    <div class="flex-grow flex flex-col justify-start">
                        <img src="${imageUrl}" loading="lazy" alt="${item.name}" class="rounded-lg w-full mb-3" onload="this.closest('.shine-animation').classList.remove('shine-animation')" onerror="this.onerror=null; this.src='https://placehold.co/200x200/374151/D1D5DB?text=Image+Not+Found';">
                        <h3 class="text-sm font-semibold truncate">${item.name}</h3>
                    </div>

                    <div class="flex items-center justify-between mt-2">
                        <p class="text-xs text-gray-400 capitalize">${rarity}</p>
                        ${sourceContent}
                    </div>

                    ${isNewBadge}
                </div>
            `;
        }

        /**
         * Gets the Tailwind color class for a given rarity.
         * @param {string} rarity The rarity of the item.
         * @returns {string} The Tailwind class for the border color.
         */
        function getRarityColor(rarity) {
            switch (rarity) {
                case 'legendary': return 'border-orange-500';
                case 'epic': return 'border-purple-500';
                case 'rare': return 'border-blue-500';
                case 'uncommon': return 'border-green-500';
                case 'common': return 'border-gray-500';
                default: return 'border-gray-500';
            }
        }
        
        /**
         * Displays a loading skeleton in the grid.
         * The skeleton elements also have the shine animation class.
         */
        function showLoadingState() {
            itemGrid.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                itemGrid.innerHTML += `
                    <div class="bg-gray-800 rounded-xl p-4 shadow-lg animate-pulse h-48 flex flex-col justify-end shine-animation">
                        <div class="bg-gray-700 h-4 w-3/4 rounded-lg mb-2"></div>
                        <div class="bg-gray-700 h-3 w-1/2 rounded-lg"></div>
                    </div>
                `;
            }
        }

        /**
         * Updates the UI to show the list of items based on current filters and sorting.
         */
        function updateGrid() {
            const data = cosmeticData[currentView] || [];
            
            const filteredData = data.filter(item => {
                const rarityMatch = currentFilterRarity === 'all' || (item.rarity && item.rarity.value === currentFilterRarity);
                const isNew = isNewItem(item);
                const newMatch = !isFilteringNew || isNew;
                const searchMatch = item.name.toLowerCase().includes(currentSearchQuery.toLowerCase());

                return rarityMatch && newMatch && searchMatch;
            });

            filteredData.sort((a, b) => {
                if (currentSortOrder === 'name') {
                    return a.name.localeCompare(b.name, currentLanguage);
                }
                const rarityOrder = ['legendary', 'epic', 'rare', 'uncommon', 'common'];
                const rarityA = a.rarity ? a.rarity.value : 'common';
                const rarityB = b.rarity ? b.rarity.value : 'common';
                return rarityOrder.indexOf(rarityA) - rarityOrder.indexOf(rarityB);
            });

            if (filteredData.length > 0) {
                itemGrid.innerHTML = filteredData.map(createItemCard).join('');
            } else {
                itemGrid.innerHTML = `<p class="col-span-full text-center text-gray-400 text-lg py-12">${translations[currentLanguage].noItemsFound}</p>`;
            }

            // Update the search results count display
            const count = filteredData.length;
            if (currentSearchQuery.trim() === '') {
                searchResultsCountDisplay.textContent = '';
            } else if (count === 0) {
                searchResultsCountDisplay.textContent = translations[currentLanguage].searchResultsCountNone;
            } else if (count === 1) {
                searchResultsCountDisplay.textContent = translations[currentLanguage].searchResultsCountOne;
            } else {
                searchResultsCountDisplay.textContent = translations[currentLanguage].searchResultsCount.replace('{count}', count);
            }
        }
        
        /**
         * Loads cosmetic data for a given category and updates the UI.
         * @param {string} category The category to load.
         */
        async function loadCosmeticsCategory(category) {
            currentView = category;
            updateNavButtons(category);
            // Show the loading skeletons with the shine animation
            showLoadingState();

            // Check if we already have the data in cache
            if (!cosmeticData[category]) {
                const data = await fetchRealCosmeticData(category);
                cosmeticData[category] = data;
            }

            updateGrid();
        }

        /**
         * Updates the active state of the navigation buttons.
         * @param {string} activeCategory The category to mark as active.
         */
        function updateNavButtons(activeCategory) {
            navButtons.forEach(btn => {
                const category = btn.getAttribute('data-category');
                if (category === activeCategory) {
                    btn.classList.add('bg-purple-600', 'text-white');
                    btn.classList.remove('bg-gray-800');
                } else {
                    btn.classList.remove('bg-purple-600', 'text-white');
                    btn.classList.add('bg-gray-800');
                }
            });
        }

        /**
         * Updates all UI text elements based on the current language.
         */
        function updateUIForLanguage() {
            const lang = translations[currentLanguage];
            document.title = lang.appTitle;

            document.getElementById('show-outfits-btn').textContent = lang.outfits;
            document.getElementById('show-backpacks-btn').textContent = lang.backpacks;
            document.getElementById('show-pickaxes-btn').textContent = lang.pickaxes;
            document.getElementById('show-gliders-btn').textContent = lang.gliders;
            document.getElementById('show-emotes-btn').textContent = lang.emotes;
            document.getElementById('show-wraps-btn').textContent = lang.wraps;
            document.getElementById('show-music-btn').textContent = lang.music;
            document.getElementById('show-lobby-backgrounds-btn').textContent = lang.lobbyBackgrounds;

            document.querySelector('label[for="sort-select"]').textContent = lang.sortLabel;
            document.getElementById('sort-select').options[0].textContent = lang.sortName;
            document.getElementById('sort-select').options[1].textContent = lang.sortRarity;

            document.querySelector('label[for="rarity-filter-select"]').textContent = lang.rarityLabel;
            document.getElementById('rarity-filter-select').options[0].textContent = lang.rarityAll;
            document.getElementById('rarity-filter-select').options[1].textContent = lang.rarityLegendary;
            document.getElementById('rarity-filter-select').options[2].textContent = lang.rarityEpic;
            document.getElementById('rarity-filter-select').options[3].textContent = lang.rarityRare;
            document.getElementById('rarity-filter-select').options[4].textContent = lang.rarityUncommon;
            document.getElementById('rarity-filter-select').options[5].textContent = lang.rarityCommon;
            
            filterNewBtn.textContent = isFilteringNew ? translations[currentLanguage].filterNewBtnActive : translations[currentLanguage].filterNewBtn;
            searchInput.placeholder = lang.searchInputPlaceholder;
            
            // Update search results count when language changes
            updateGrid();
        }

        /**
         * Populates and shows the detailed item modal.
         * @param {Object} item The item to display in the modal.
         */
        function showItemDetails(item) {
            const lang = translations[currentLanguage];
            const rarity = item.rarity ? item.rarity.value : 'common';
            const rarityClass = getRarityColor(rarity);

            // Determine the source text to display
            let sourceText = lang.noPriceInfo;
            let priceSection = '';
            if (item.price && item.price.price > 0 && item.price.currency === 'VBuck') {
                sourceText = lang.shop;
                priceSection = `<div class="mt-4">
                                    <h3 class="text-lg font-semibold">${lang.price}</h3>
                                    <div class="flex items-center space-x-2 text-sm text-gray-300">
                                        ${vbucksIcon}
                                        <span>${item.price.price}</span>
                                    </div>
                                </div>`;
            } else if (item.battlepass) {
                sourceText = lang.battlepass;
            } else if (item.crew) {
                sourceText = lang.crew;
            }
            
            // Logic to determine how many days ago the item was last seen
            let lastSeenSection = '';
            if (item.shopHistory && item.shopHistory.length > 0) {
                const lastSeenDate = new Date(item.shopHistory[0].date);
                const today = new Date();
                const diffInTime = today.getTime() - lastSeenDate.getTime();
                const diffInDays = Math.floor(diffInTime / (1000 * 3600 * 24));
                
                if (diffInDays === 0) {
                    lastSeenSection = `<div class="mt-4">
                                         <h3 class="text-lg font-semibold">${lang.lastSeenToday}</h3>
                                     </div>`;
                } else {
                    lastSeenSection = `<div class="mt-4">
                                         <h3 class="text-lg font-semibold">${lang.lastSeen.replace('{days}', diffInDays)}</h3>
                                     </div>`;
                }
            }
            
            modalContent.innerHTML = `
                <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-400 hover:text-gray-100 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <div class="flex flex-col md:flex-row items-start space-y-4 md:space-y-0 md:space-x-6">
                    <!-- Image container -->
                    <div class="md:w-1/2">
                        <img src="${item.images.featured || item.images.icon}" alt="${item.name}" class="rounded-lg w-full border-2 ${rarityClass}" onerror="this.onerror=null; this.src='https://placehold.co/400x400/374151/D1D5DB?text=Image+Not+Found';">
                    </div>
                    <!-- Details container -->
                    <div class="md:w-1/2 flex flex-col justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-50 mb-2">${item.name}</h2>
                            <p class="text-sm text-gray-400 capitalize mb-4">${rarity} ${item.type.displayValue}</p>
                            <h3 class="text-lg font-semibold mb-2">${lang.description}</h3>
                            <p class="text-sm text-gray-300 mb-4">${item.description || lang.noDescription}</p>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold">${lang.source}</h3>
                            <p class="text-sm text-gray-300">${sourceText}</p>
                            ${priceSection}
                            ${lastSeenSection} <!-- Add the last seen section here -->
                        </div>
                    </div>
                </div>
            `;
            
            // Re-attach event listener to the new close button
            document.getElementById('close-modal-btn').addEventListener('click', hideItemDetails);
            
            modalBackdrop.classList.add('active');
        }

        /**
         * Hides the detailed item modal.
         */
        function hideItemDetails() {
            modalBackdrop.classList.remove('active');
        }

        // --- Event Listeners ---
        
        // Listen for clicks on navigation buttons
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const category = button.getAttribute('data-category');
                
                // Load the category
                loadCosmeticsCategory(category);
            });
        });
        
        // Listen for changes in the sort dropdown
        sortSelect.addEventListener('change', (event) => {
            currentSortOrder = event.target.value;
            updateGrid();
        });

        // Listen for changes in the rarity filter dropdown
        rarityFilterSelect.addEventListener('change', (event) => {
            currentFilterRarity = event.target.value;
            updateGrid();
        });
        
        // Listen for changes in the language select
        languageSelect.addEventListener('change', async (event) => {
            currentLanguage = event.target.value;
            // Clear cached data to force a re-fetch in the new language
            cosmeticData = {};
            updateUIForLanguage();
            await loadCosmeticsCategory(currentView);
        });
        
        // Listen for input in the search field
        searchInput.addEventListener('input', (event) => {
            currentSearchQuery = event.target.value;
            updateGrid();
        });

        // Toggle the "Filter New" state
        filterNewBtn.addEventListener('click', () => {
            isFilteringNew = !isFilteringNew;
            filterNewBtn.textContent = isFilteringNew ? translations[currentLanguage].filterNewBtnActive : translations[currentLanguage].filterNewBtn;
            updateGrid();
        });

        // Event listener to show/hide the scroll-to-top button
        window.addEventListener('scroll', () => {
            if (window.scrollY > 200) { // Show button after scrolling 200px
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        });

        // Event listener to scroll to the top when the button is clicked
        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
        
        // Close modal when clicking on the backdrop
        modalBackdrop.addEventListener('click', (e) => {
            if (e.target === modalBackdrop) {
                hideItemDetails();
            }
        });

        // --- Initial Application Load ---
        /**
         * Initializes the app on page load.
         */
        async function initializeApp() {
            // Set initial state from HTML selects
            currentLanguage = languageSelect.value;
            currentSortOrder = sortSelect.value;
            currentFilterRarity = rarityFilterSelect.value;

            appVersionDisplay.textContent = appVersion;

            // Load initial category ('outfit') and set UI state
            await loadCosmeticsCategory('outfit');
            updateUIForLanguage();
        }

        initializeApp();
    </script>
</body>
</html>
